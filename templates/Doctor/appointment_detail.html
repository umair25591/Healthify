{% extends "Doctor/layout.html" %}

{% block title %}Appointment Details - Healthify{% endblock %}

{% block content %}
<div class="appointment-wrapper">
    <style>
        .appointment-wrapper {
            padding: 2rem;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            color: white;
        }

        .page-header h2 {
            margin: 0;
        }

        .page-header p {
            margin: .25rem 0 0;
            color: rgba(255, 255, 255, 0.85);
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: .85rem;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .status-badge {
            padding: .35rem .75rem;
            border-radius: 20px;
            font-size: .8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-confirmed {
            background: rgba(34, 197, 94, .1);
            color: #22c55e;
        }

        .status-active {
            background: rgba(59, 130, 246, .1);
            color: #3b82f6;
        }

        .status-completed {
            background: rgba(16, 185, 129, .1);
            color: #10b981;
        }

        .status-cancelled {
            background: rgba(239, 68, 68, .1);
            color: #ef4444;
        }

        .status-no_show {
            background: rgba(250, 204, 21, .15);
            color: #ca8a04;
        }

        /* Quick Actions */
        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            flex: 1;
            min-width: 160px;
            padding: .85rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            cursor: pointer;
            transition: .2s;
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tab {
            padding: .75rem 1.25rem;
            border-radius: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: 600;
            transition: .2s;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h3 {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .info-item {
            margin-bottom: .75rem;
        }

        .info-label {
            font-size: .85rem;
            color: var(--text-light);
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: .35rem;
            font-weight: 500;
            font-size: .9rem;
        }

        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: .75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-primary);
        }

        .history-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-size: .8rem;
            color: var(--text-light);
            margin-bottom: .25rem;
        }

        .history-content h4 {
            margin: 0 0 .25rem;
            font-size: .95rem;
            color: var(--text-primary);
        }

        .history-content p {
            margin: 0;
            font-size: .85rem;
            color: var(--text-light);
        }

        .margin15 {
            margin-top: 15px;
        }

        .margin5 {
            margin-top: 5px;
        }
    </style>

    <!-- Header -->
    <div class="page-header">
        <h2>{{ appointment.patient_name }}</h2>
        <p>{{ appointment.start_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
    </div>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-number">
                <span class="status-badge status-{{ appointment.status }}">{{ appointment.status|title }}</span>
            </div>
            <div class="stat-label margin15">Status</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ specialties[appointment.specialty].name if appointment.specialty in specialties
                else appointment.specialty|title }}</div>
            <div class="stat-label margin15">Specialty</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ appointment.start_at.strftime('%I:%M %p') }} - {{
                appointment.end_at.strftime('%I:%M %p') }}</div>
            <div class="stat-label margin15">Time</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="actions-row">
        {% if appointment.status != "completed" and appointment.status != "cancelled" %}
        {% if appointment.status == "confirmed" %}
        <button class="action-btn" onclick="startAppointment('{{ appointment._id }}')">
            <i class="fas fa-play"></i> Start
        </button>
        {% endif %}
        {% if appointment.status == "active" %}
        <button class="action-btn" onclick="completeAppointment('{{ appointment._id }}')">
            <i class="fas fa-check"></i> Complete
        </button>
        {% endif %}
        {% endif %}

        <button class="action-btn" onclick="scheduleFollowUp()">
            <i class="fas fa-calendar-plus"></i> Follow-up
        </button>
        <button class="action-btn" onclick="sendMessage()">
            <i class="fas fa-comment"></i> Message
        </button>
    </div>


    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="showTab('details')">Details</div>
        <div class="tab" onclick="showTab('clinical')">Clinical Notes</div>
        <div class="tab" onclick="showTab('history')">History</div>
    </div>

    <!-- Details -->
    <div id="details" class="tab-content active">
        <div class="card">
            <h3>Appointment Info</h3>
            <div class="info-item"><span class="info-label">Patient Email</span>
                <div class="info-value margin5">{{ appointment.patient_email }}</div>
            </div>
            {% if appointment.notes %}
            <div class="info-item"><span class="info-label">Patient Notes</span>
                <div class="info-value margin5">{{ appointment.notes }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Clinical Notes -->
    <div id="clinical" class="tab-content">
        <form id="appointmentForm" class="card">
            <h3>Update Clinical Information</h3>
            <div class="form-group">
                <label>Status</label>
                <select name="status" id="status">
                    <option value="confirmed" {% if appointment.status=='confirmed' %}selected{% endif %}>Confirmed
                    </option>
                    <option value="active" {% if appointment.status=='active' %}selected{% endif %}>Active</option>
                    <option value="completed" {% if appointment.status=='completed' %}selected{% endif %}>Completed
                    </option>
                    <option value="cancelled" {% if appointment.status=='cancelled' %}selected{% endif %}>Cancelled
                    </option>
                    <option value="no_show" {% if appointment.status=='no_show' %}selected{% endif %}>No Show</option>
                </select>
            </div>
            <div class="form-group">
                <label>Diagnosis</label>
                <textarea name="diagnosis">{{ appointment.diagnosis or '' }}</textarea>
            </div>
            <div class="form-group">
                <label>Prescription</label>
                <textarea name="prescription">{{ appointment.prescription or '' }}</textarea>
            </div>
            <div class="form-group">
                <label>Doctor Notes</label>
                <textarea name="notes">{{ appointment.doctor_notes or '' }}</textarea>
            </div>
            <button type="submit" class="action-btn" style="background:var(--primary-color);color:#fff;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </div>

    <!-- History -->
    <div id="history" class="tab-content">
        <div class="card">
            <h3>Previous Appointments</h3>
            {% if patient_appointments %}
            {% for prev in patient_appointments %}
            <div class="history-item">
                <div class="history-date">{{ prev.start_at.strftime('%B %d, %Y') }}</div>
                <div class="history-content">
                    <h4>{{ specialties[prev.specialty].name if prev.specialty in specialties else prev.specialty|title
                        }}</h4>
                    <p><span class="status-badge status-{{ prev.status }}">{{ prev.status|title }}</span></p>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p style="color:var(--text-light);">No previous appointments.</p>
            {% endif %}
        </div>

    </div>
</div>

<script>
    function showTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    // Save clinical info
    document.getElementById('appointmentForm').addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        fetch(`{{ url_for('doctor_appointment_update', appointment_id=appointment._id) }}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        }).then(r => r.json()).then(res => {
            if (res.success) { alert('Appointment updated'); location.reload(); }
            else alert('Error: ' + res.message);
        }).catch(err => { alert('Error updating appointment'); console.error(err); });
    });

    function scheduleFollowUp() { alert('Follow-up scheduling coming soon!'); }
    function sendMessage() { alert('Messaging system coming soon!'); }

    function startAppointment(appointmentId) {
        if (!confirm("Start this appointment?")) return;

        fetch(`/doctor/appointment/${appointmentId}/start`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Appointment started. Meeting link sent to patient and doctor.");
                window.open(data.meeting_link, "_blank");
                location.reload();
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(err => {
            console.error("Error starting appointment:", err);
            alert("Failed to start appointment. Try again.");
        });
    }

    function completeAppointment(appointmentId) {
        if (!confirm("appointment completed?")) return;

        fetch(`/doctor/appointment/${appointmentId}/complete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(err => {
            console.error("Error starting appointment:", err);
            alert("Failed to start appointment. Try again.");
        });
    }
</script>
{% endblock %}