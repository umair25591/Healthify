{% extends "layout.html" %}
{% block title %}Book Appointment - Healthify{% endblock %}

{% block content %}
<style>
  /* ====== CORE LAYOUT ====== */
  .booking-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
  .booking-steps { display: flex; justify-content: center; margin-bottom: 2rem; gap: 1rem; }
  .step { display:flex; align-items:center; gap:.5rem; padding:.75rem 1.5rem; border-radius:25px; background:var(--bg-secondary); color:var(--text-secondary); font-weight:500; transition:.3s; }
  .step.active { background:var(--primary-color); color:#fff; }
  .step.completed { background:var(--success-color); color:#fff; }
  .step-number { width:24px; height:24px; border-radius:50%; background:rgba(255,255,255,.2); display:flex; align-items:center; justify-content:center; font-size:.8rem; font-weight:700; }

  .form-card { background:var(--card-bg); padding:2rem; border-radius:16px; box-shadow:var(--shadow); margin-bottom:1.5rem; }
  .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
  .form-row.single { grid-template-columns:1fr; }
  .form-group { display:flex; flex-direction:column; gap:.5rem; }
  .form-group label { color:var(--text-primary); font-size:.95rem; font-weight:500; }
  .form-group input, .form-group select, .form-group textarea { background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); border-radius:10px; padding:12px; font-size:.9rem; transition:.2s; }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:var(--primary-color); box-shadow:0 0 0 3px rgba(59,130,246,.1); }
  .form-group select option { background:var(--card-bg); color:var(--text-primary); padding:8px 12px; }

  .actions { display:flex; gap:1rem; margin-top:2rem; justify-content:flex-end; }
  .btn { padding:12px 24px; border-radius:10px; border:1px solid var(--primary-color); color:var(--primary-color); background:transparent; cursor:pointer; text-decoration:none; font-weight:500; transition:.2s; display:inline-flex; align-items:center; gap:.5rem; }
  .btn-primary { background:var(--primary-color); color:#fff; }
  .btn-primary:hover { background:var(--primary-dark); transform:translateY(-1px); }
  .btn-secondary { border-color:var(--border-color); color:var(--text-secondary); }
  .btn-secondary:hover { background:var(--bg-secondary); }

  .error-message { background: var(--danger-color); color:#fff; padding:1rem; border-radius:8px; margin-bottom:1rem; }

  /* ====== LOADERS (fixed) ====== */
  .loading { display:flex; align-items:center; justify-content:center; padding:2rem; color:var(--text-secondary); gap:.5rem; }
  .loading::after { content:''; display:inline-block; width:20px; height:20px; border:2px solid var(--border-color); border-top:2px solid var(--primary-color); border-radius:50%; animation: spin 1s linear infinite; box-sizing:border-box; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ====== DOCTORS GRID ====== */
  .doctors-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:1rem; margin-top:1rem; }
  .doctor-card { background:var(--bg-secondary); border:2px solid var(--border-color); border-radius:12px; padding:1.5rem; cursor:pointer; transition:.2s; }
  .doctor-card:hover { border-color:var(--primary-color); transform: translateY(-2px); }
  .doctor-card.selected { border-color:var(--primary-color); background: rgba(59,130,246,.05); }
  .doctor-header { display:flex; align-items:center; gap:1rem; margin-bottom:1rem; }
  .doctor-avatar { width:50px; height:50px; border-radius:50%; background:var(--primary-color); display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.2rem; font-weight:700; }
  .doctor-info h3 { margin:0; color:var(--text-primary); font-size:1.1rem; }
  .doctor-info p { margin:.25rem 0 0 0; color:var(--text-secondary); font-size:.9rem; }
  .doctor-details { display:flex; flex-direction:column; gap:.5rem; }
  .detail-item { display:flex; justify-content:space-between; font-size:.9rem; }
  .detail-label { color:var(--text-secondary); }
  .detail-value { color:var(--text-primary); font-weight:500; }

  /* ====== STEP 3: WEEKLY STRIP + NEXT AVAILABLE ====== */
  .availability-container-grid { display:grid; grid-template-columns: 1fr 1fr; gap:2rem; margin-top:1.5rem; }
  .calendar-pane, .time-pane { background:var(--bg-secondary); border-radius:12px; padding:1rem; min-height:400px; display:flex; flex-direction:column; }
  .calendar-pane h3, .time-pane h3 { margin:0 0 1rem 0; color:var(--text-primary); font-size:1.1rem; font-weight:600; }
  .time-pane-header { display:flex; align-items:center; gap:.75rem; color:var(--text-primary); border-bottom:1px solid var(--border-color); padding-bottom:.75rem; margin-bottom:.5rem; }
  .time-pane-subheader { color:var(--text-secondary); font-size:.9rem; margin-bottom:1rem; }

  /* week navigation + strip */
  .week-nav { display:flex; align-items:center; justify-content:space-between; border:1px solid var(--border-color); background:var(--bg-secondary); border-radius:10px; padding:.5rem .75rem; margin-bottom:.75rem; }
  .week-btn { background:var(--primary-color); color:#fff; border:none; border-radius:8px; padding:.35rem .6rem; cursor:pointer; font-weight:600; }
  #week-range { color:var(--text-primary); font-weight:600; }
  .week-strip { display:grid; grid-template-columns: repeat(7,1fr); gap:.5rem; }
  .day-pill { background:var(--bg-secondary); border:2px solid var(--border-color); border-radius:12px; padding:.75rem .5rem; text-align:center; cursor:pointer; transition:.2s; display:flex; flex-direction:column; gap:.25rem; }
  .day-pill:hover { border-color: var(--primary-color); transform:translateY(-1px); }
  .day-pill.disabled { opacity:.35; cursor:not-allowed; }
  .day-pill.selected { border-color: var(--primary-color); background: rgba(59,130,246,.08); }
  .day-pill .dow { font-size:.8rem; color:var(--text-secondary); }
  .day-pill .date { font-size:1rem; font-weight:700; color:var(--text-primary); line-height:1; }
  .day-pill .count { margin-top:.15rem; font-size:.7rem; color:#fff; background:var(--success-color); padding:.15rem .4rem; border-radius:999px; align-self:center; }

  /* next available */
  .next-available { margin-bottom:.75rem; }
  .na-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
  .na-title { font-weight:600; color:var(--text-primary); }
  .na-list { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:.5rem; }
  .na-chip { border:2px solid var(--border-color); background:var(--card-bg); color:var(--text-primary); border-radius:999px; padding:.5rem .75rem; font-weight:600; cursor:pointer; transition:.2s; text-align:center; }
  .na-chip:hover { border-color:var(--primary-color); transform: translateY(-1px); }

  /* time slots (kept from your design) */
  .time-slots-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:.75rem; margin-top:1rem; min-height:200px; }
  .time-slot { background:var(--bg-secondary); color:var(--text-primary); border:2px solid var(--border-color); border-radius:12px; padding:1.25rem 1rem; text-align:center; cursor:pointer; transition:.2s; font-weight:600; font-size:1rem; position:relative; overflow:hidden; }
  .time-slot:hover { border-color:var(--primary-color); transform: translateY(-3px); box-shadow:0 8px 25px rgba(59,130,246,.15); }
  .time-slot.selected { background:var(--primary-color); color:#fff; border-color:var(--primary-color); box-shadow:0 8px 25px rgba(59,130,246,.3); transform: translateY(-2px); }
  .time-slot-content { position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; gap:.25rem; }
  .time-slot-time { font-size:1.1rem; font-weight:700; }
  .time-slot-duration { font-size:.8rem; opacity:.8; font-weight:400; }
  .no-slots-message { grid-column: 1 / -1; text-align:center; padding:2rem; color:var(--text-secondary); background:var(--bg-secondary); border-radius:12px; border:2px dashed var(--border-color); }

  /* responsive */
  @media (max-width: 992px){ .availability-container-grid { grid-template-columns:1fr; } }
  @media (max-width: 768px){
    .booking-container{ padding:1rem; } .booking-steps{ flex-direction:column; align-items:center; }
    .form-row{ grid-template-columns:1fr; }
    .na-list{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
</style>

<div class="booking-container">
  <header>
    <div class="header-title">
      <h1>Book an Appointment</h1>
      <p>Select a specialty, choose your doctor, and pick an available time slot.</p>
    </div>
    {% if selected_specialty %}
      <p style="margin-top:8px;">Selected: <strong>{{ selected_specialty.name }}</strong></p>
    {% endif %}
  </header>

  <div class="booking-steps">
    <div class="step active" id="step-1"><div class="step-number">1</div><span>Select Specialty</span></div>
    <div class="step" id="step-2"><div class="step-number">2</div><span>Choose Doctor</span></div>
    <div class="step" id="step-3"><div class="step-number">3</div><span>Pick Time</span></div>
    <div class="step" id="step-4"><div class="step-number">4</div><span>Confirm</span></div>
  </div>

  <form method="POST" action="{{ url_for('book_appointment') }}" id="booking-form">
    {% if prediction %}
      <input type="hidden" name="prediction_id" value="{{ prediction._id }}" />
    {% endif %}

    <!-- Step 1 -->
    <div class="form-card" id="step-1-content">
      <h2>Select Medical Specialty</h2>
      <div class="form-row single">
        <div class="form-group">
          <label for="specialty">Specialty</label>
          <select id="specialty" name="specialty" required>
            <option value="">Select specialty</option>
            {% for key, spec in specialties.items() %}
              <option value="{{ key }}" {% if selected_specialty_key==key %}selected{% endif %}>{{ spec.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="actions">
        <button type="button" class="btn btn-primary" onclick="nextStep()">Next: Choose Doctor</button>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="form-card" id="step-2-content" style="display:none;">
      <h2>Choose Your Doctor</h2>
      <div id="doctors-loading" class="loading">Loading available doctors...</div>
      <div id="doctors-container" style="display:none;">
        <div class="doctors-grid" id="doctors-grid"></div>
      </div>
      <div id="doctors-error" class="error-message" style="display:none;"></div>
      <div class="actions">
        <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
        <button type="button" class="btn btn-primary" onclick="nextStep()" id="next-doctor-btn" disabled>Next: Pick Time</button>
      </div>
    </div>

    <!-- Step 3 (Weekly strip + Next available) -->
    <div class="form-card" id="step-3-content" style="display:none;">
      <h2>Select Date and Time</h2>
      <div id="availability-loading" class="loading">Loading doctor availability...</div>

      <div id="availability-container" class="availability-container-grid" style="display:none;">
        <div class="calendar-pane">
          <h3 id="selected-doctor-name-calendar"></h3>

          <!-- Next available panel -->
          <div class="next-available" id="next-available" style="display:none;">
            <div class="na-header">
              <div class="na-title">Next available</div>
              <small class="na-tip" style="color:var(--text-secondary);">Tap to pick instantly</small>
            </div>
            <div class="na-list" id="na-list"></div>
          </div>

          <!-- Weekly navigation + strip -->
          <div class="week-nav">
            <button type="button" class="week-btn" id="week-prev">‚Äπ</button>
            <div id="week-range"></div>
            <button type="button" class="week-btn" id="week-next">‚Ä∫</button>
          </div>
          <div id="week-strip" class="week-strip"></div>
        </div>

        <div class="time-pane">
          <h3 class="time-pane-header"><i class="fas fa-clock"></i><span>Available Times</span></h3>
          <p id="time-pane-date" class="time-pane-subheader">Please select a date.</p>
          <div id="time-slots-grid" class="time-slots-grid"></div>
        </div>
      </div>

      <div id="availability-error" class="error-message" style="display:none;"></div>
      <div class="actions">
        <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
        <button type="button" class="btn btn-primary" onclick="nextStep()" id="next-time-btn" disabled>Next: Confirm</button>
      </div>
    </div>

    <!-- Step 4 -->
    <div class="form-card" id="step-4-content" style="display:none;">
      <h2>Confirm Your Appointment</h2>
      <div id="appointment-summary">
        <div class="form-row">
          <div class="form-group">
            <label>Specialty</label>
            <input type="text" id="summary-specialty" readonly>
          </div>
          <div class="form-group">
            <label>Doctor</label>
            <input type="text" id="summary-doctor" readonly>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date</label>
            <input type="text" id="summary-date" readonly>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" id="summary-time" readonly>
          </div>
        </div>
        <div class="form-row single">
          <div class="form-group">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" name="notes" rows="4" placeholder="Brief symptoms or questions for the doctor."></textarea>
          </div>
        </div>
      </div>
      <div class="actions">
        <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
        <button type="submit" class="btn btn-primary">Confirm Booking</button>
      </div>
    </div>
  </form>

  {% if prediction %}
  <div class="form-card" style="margin-top:16px;">
    <h3 style="margin-top:0;">Attached Prediction Context</h3>
    <p><strong>Type:</strong> {{ prediction.disease_type|capitalize }} | <strong>Result:</strong> {{ prediction.prediction_result }} ({{ prediction.confidence_probability }}%)</p>
    <p style="margin:0; color: var(--text-light);">Made on {{ (prediction.timestamp).strftime('%B %d, %Y at %I:%M %p') }}</p>
    {% if prediction.patient_details %}
      <p style="margin-top:8px;"><strong>Patient:</strong> {{ prediction.patient_details.get('patientName', 'N/A') }}, {{ prediction.patient_details.get('patientAge', 'N/A') }}</p>
    {% endif %}
  </div>
  {% endif %}
</div>

<script>
  /* ====== STATE ====== */
  let currentStep = 1;
  let selectedSpecialty = '';
  let selectedDoctor = null;
  let selectedDate = '';
  let selectedTime = '';
  let doctorAvailability = [];      // [{date:'YYYY-MM-DD', is_available:true, available_slots:[{start:'HH:MM'}]}]
  let currentWeekStart = null;      // Date (Monday/Sunday depending on setting)
  const useMondayStart = true;

  // Hidden form fields
  const specialtyInput = Object.assign(document.createElement('input'), { type:'hidden', name:'specialty', id:'specialty-hidden' });
  const doctorInput    = Object.assign(document.createElement('input'), { type:'hidden', name:'doctor_id', id:'doctor-id-hidden' });
  const dateInput      = Object.assign(document.createElement('input'), { type:'hidden', name:'date', id:'date-hidden' });
  const timeInput      = Object.assign(document.createElement('input'), { type:'hidden', name:'time', id:'time-hidden' });
  document.getElementById('booking-form').append(specialtyInput, doctorInput, dateInput, timeInput);

  /* ====== STEP NAV ====== */
  function nextStep(){
    if (currentStep === 1){
      const specialty = document.getElementById('specialty').value;
      if (!specialty){ alert('Please select a specialty'); return; }
      selectedSpecialty = specialty; specialtyInput.value = specialty; loadDoctors(specialty);
    } else if (currentStep === 2){
      if (!selectedDoctor){ alert('Please select a doctor'); return; }
      loadDoctorAvailability();
    } else if (currentStep === 3){
      if (!selectedDate || !selectedTime){ alert('Please select a date and time'); return; }
      updateSummary();
    }
    if (currentStep < 4){ currentStep++; updateStepDisplay(); }
  }
  function prevStep(){ if (currentStep > 1){ currentStep--; updateStepDisplay(); } }
  function updateStepDisplay(){
    for (let i=1;i<=4;i++){
      const step = document.getElementById(`step-${i}`);
      const content = document.getElementById(`step-${i}-content`);
      if (i < currentStep){ step.className = 'step completed'; content.style.display='none'; }
      else if (i === currentStep){ step.className = 'step active'; content.style.display='block'; }
      else { step.className = 'step'; content.style.display='none'; }
    }
  }

  /* ====== STEP 2: Doctors ====== */
  async function loadDoctors(specialty){
    const loadingDiv = document.getElementById('doctors-loading');
    const containerDiv = document.getElementById('doctors-container');
    const errorDiv = document.getElementById('doctors-error');
    const gridDiv = document.getElementById('doctors-grid');
    loadingDiv.style.display='block'; containerDiv.style.display='none'; errorDiv.style.display='none'; gridDiv.innerHTML='';
    try{
      const res = await fetch(`/api/specialty/${specialty}/doctors`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (data.success){
        if (!data.doctors.length){ errorDiv.textContent='No doctors available for this specialty at the moment.'; errorDiv.style.display='block'; }
        else { displayDoctors(data.doctors); containerDiv.style.display='block'; }
      } else { errorDiv.textContent = data.error || 'Failed to load doctors'; errorDiv.style.display='block'; }
    } catch(e){ console.error(e); errorDiv.textContent='Failed to load doctors. Please try again.'; errorDiv.style.display='block'; }
    finally{ loadingDiv.style.display='none'; }
  }
  function displayDoctors(doctors){
    const grid = document.getElementById('doctors-grid'); grid.innerHTML='';
    doctors.forEach(doctor=>{
      const card = document.createElement('div'); card.className='doctor-card'; card.onclick = (ev)=>selectDoctor(ev, doctor);
      const initials = doctor.full_name.split(' ').map(n=>n[0]).join('');
      card.innerHTML = `
        <div class="doctor-header">
          <div class="doctor-avatar">${initials}</div>
          <div class="doctor-info">
            <h3>${doctor.full_name}</h3>
            <p>${doctor.qualification || ''}</p>
          </div>
        </div>
        <div class="doctor-details">
          <div class="detail-item"><span class="detail-label">Experience:</span><span class="detail-value">${doctor.experience_years ?? '‚Äî'} years</span></div>
          <div class="detail-item"><span class="detail-label">Status:</span><span class="detail-value">${doctor.status ?? '‚Äî'}</span></div>
        </div>`;
      grid.appendChild(card);
    });
  }
  function selectDoctor(event, doctor){
    selectedDoctor = doctor;
    document.querySelectorAll('.doctor-card').forEach(c=>c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('next-doctor-btn').disabled = false;
    doctorInput.value = doctor._id;
  }

  /* ====== STEP 3: Availability (Weekly Strip + Next Available) ====== */
  async function loadDoctorAvailability(){
    const loadingDiv = document.getElementById('availability-loading');
    const containerDiv = document.getElementById('availability-container');
    const errorDiv = document.getElementById('availability-error');
    loadingDiv.style.display='block'; containerDiv.style.display='none'; errorDiv.style.display='none';

    document.getElementById('selected-doctor-name-calendar').textContent = `Availability for ${selectedDoctor.full_name}`;

    try{
      const startDate = new Date(); const endDate = new Date(); endDate.setDate(startDate.getDate()+60);
      const qs = `start_date=${isoLocal(startDate)}&end_date=${isoLocal(endDate)}`;
      const res = await fetch(`/api/doctor/${selectedDoctor._id}/availability?${qs}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      console.log(data)
      if (data.success){
        doctorAvailability = data.availability || [];
        currentWeekStart = startOfWeek(new Date());
        renderWeekStrip();
        renderNextAvailable();     // Optional panel
        containerDiv.style.display='grid';
      } else {
        errorDiv.textContent = data.error || 'Failed to load availability'; errorDiv.style.display='block';
      }
    } catch(e){ console.error(e); errorDiv.textContent='Failed to load availability. Please try again.'; errorDiv.style.display='block'; }
    finally{ loadingDiv.style.display='none'; }
  }

  function availabilityMap(){
    const m = new Map(); (doctorAvailability||[]).forEach(a=>m.set(a.date, a)); return m;
  }
  function startOfWeek(date){
    const d = new Date(date); const day = d.getDay(); const diff = useMondayStart ? (day===0 ? -6 : 1 - day) : -day;
    d.setDate(d.getDate()+diff); d.setHours(0,0,0,0); return d;
  }
  function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
  function isoLocal(d){ return d.toISOString().split('T')[0]; }
  function humanRange(s,e){
    const o = { month:'long', day:'numeric' };
    const a = s.toLocaleDateString(undefined,o), b = e.toLocaleDateString(undefined,o);
    const y = s.getFullYear()===e.getFullYear() ? '' : `, ${e.getFullYear()}`;
    return `${a} ‚Äì ${b}${y}`;
  }

  function renderWeekStrip(){
    const weekStrip = document.getElementById('week-strip');
    const range = document.getElementById('week-range');
    const map = availabilityMap();
    const days = []; for(let i=0;i<7;i++) days.push(addDays(currentWeekStart,i));
    range.textContent = humanRange(days[0], days[6]);
    weekStrip.innerHTML = '';

    const todayISO = isoLocal(new Date());

    days.forEach(d=>{
      const iso = isoLocal(d);
      const a = map.get(iso);
      const slots = (a?.is_available ? (a.available_slots || []) : []);
      const available = a && a.is_available && slots.length > 0;
      const past = iso < todayISO;

      const div = document.createElement('div');
      div.className = 'day-pill' + (available && !past ? '' : ' disabled');
      if (selectedDate === iso) div.classList.add('selected');

      div.innerHTML = `
        <div class="dow">${d.toLocaleDateString(undefined,{weekday:'short'})}</div>
        <div class="date">${d.getDate()}</div>
        ${available && !past ? `<div class="count">${slots.length} slots</div>` : ''}
      `;

      if (available && !past){
        div.onclick = () => {
          document.querySelectorAll('.day-pill').forEach(p=>p.classList.remove('selected'));
          div.classList.add('selected');
          selectDate(iso);
        };
      }
      weekStrip.appendChild(div);
    });

    document.getElementById('week-prev').onclick = ()=>{ currentWeekStart = addDays(currentWeekStart,-7); renderWeekStrip(); };
    document.getElementById('week-next').onclick = ()=>{ currentWeekStart = addDays(currentWeekStart, 7); renderWeekStrip(); };
  }

  // Optional panel: first N upcoming slots across days
  function renderNextAvailable(limit=12){
    const list = document.getElementById('na-list'); const wrap = document.getElementById('next-available');
    const items = [];
    const now = new Date();

    (doctorAvailability||[]).forEach(day=>{
      if (!day.is_available || !day.available_slots?.length) return;
      day.available_slots.forEach(s=>{
        const dt = new Date(`${day.date}T${s.start}:00`);
        if (dt >= now) items.push({ date: day.date, time: s.start, dt });
      });
    });

    items.sort((a,b)=>a.dt-b.dt);
    const top = items.slice(0, limit);

    if (!top.length){ wrap.style.display='none'; return; }
    wrap.style.display='block';
    list.innerHTML = '';

    top.forEach(it=>{
      const chip = document.createElement('div');
      chip.className = 'na-chip';
      chip.textContent = `${formatDateForShort(it.date)} ‚Ä¢ ${formatTime12Hour(it.time)}`;
      chip.onclick = async ()=>{
        // ensure week strip selection & time grid are in sync
        selectedDate = it.date; dateInput.value = it.date;
        renderWeekStrip(); // to visually mark the day
        selectDate(it.date); // will render the grid
        // after grid render, select the time
        setTimeout(()=>{
          const nodes = [...document.querySelectorAll('#time-slots-grid .time-slot')];
          const match = nodes.find(n => n.dataset.time === it.time);
          if (match){ match.click(); }
        }, 0);
      };
      list.appendChild(chip);
    });
  }

  function selectDate(date){
    selectedDate = date; dateInput.value = date;
    selectedTime = ''; timeInput.value = '';
    document.getElementById('next-time-btn').disabled = true;
    document.getElementById('time-pane-date').textContent = `On ${formatDateForDisplay(date)}`;
    const availabilityForDate = (doctorAvailability||[]).find(a=>a.date===date);
    displayTimeSlots(availabilityForDate ? availabilityForDate.available_slots : []);
  }

  function displayTimeSlots(slots){
    const grid = document.getElementById('time-slots-grid'); grid.innerHTML='';
    if (!slots || !slots.length){
      grid.innerHTML = `
        <div class="no-slots-message">
          <div style="font-size:2rem; margin-bottom:.5rem; opacity:.5;">üóìÔ∏è</div>
          <h4 style="margin:.25rem 0; color:var(--text-primary);">No Available Slots</h4>
          <p style="margin:0; color:var(--text-secondary);">No time slots are available for this date. Please select another date.</p>
        </div>`;
      return;
    }
    slots.forEach(slot=>{
      const div = document.createElement('div');
      div.className = 'time-slot';
      div.dataset.time = slot.start;   // so the NA panel can click-match
      div.onclick = (ev)=>selectTime(ev, slot.start);
      div.innerHTML = `
        <div class="time-slot-content">
          <div class="time-slot-time">${formatTime12Hour(slot.start)}</div>
          <div class="time-slot-duration">30 min session</div>
        </div>`;
      grid.appendChild(div);
    });
  }

  function selectTime(event, time){
    selectedTime = time; timeInput.value = time;
    document.querySelectorAll('.time-slot').forEach(s=>s.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('next-time-btn').disabled = false;
  }

  /* ====== UTIL ====== */
  function formatTime12Hour(time24){
    if (!time24) return '';
    const [h,m] = time24.split(':'); const d = new Date(0,0,0, h, m);
    return d.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', hour12:true });
  }
  function updateSummary(){
    const sel = document.getElementById('specialty'); const opt = sel.options[sel.selectedIndex];
    document.getElementById('summary-specialty').value = opt.text;
    document.getElementById('summary-doctor').value = selectedDoctor.full_name;
    document.getElementById('summary-date').value = formatDateForDisplay(selectedDate);
    document.getElementById('summary-time').value = formatTime12Hour(selectedTime);
  }
  function formatDateForDisplay(dateStr){
    const d = new Date(dateStr+'T00:00:00');
    return d.toLocaleString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  }
  function formatDateForShort(dateStr){
    const d = new Date(dateStr+'T00:00:00');
    return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
  }

  /* ====== INIT ====== */
  document.addEventListener('DOMContentLoaded', ()=>{
    updateStepDisplay();
    const specialtySelect = document.getElementById('specialty');
    if (specialtySelect.value){ selectedSpecialty = specialtySelect.value; specialtyInput.value = selectedSpecialty; }
  });

  function isoLocal(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }
</script>
{% endblock %}
