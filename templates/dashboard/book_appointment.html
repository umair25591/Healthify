{% extends "layout.html" %}

{% block title %}Book Appointment - Healthify{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>

    /* Styling for Flatpickr Calendar */
    .flatpickr-calendar {
        width: 100% !important;
        box-shadow: none !important;
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 12px !important;
        color: var(--text-primary) !important;
        font-family: inherit !important;
    }
    
    .flatpickr-calendar.open {
        display: inline-block !important;
        z-index: 1000 !important;
    }
    
    .flatpickr-months {
        background: var(--primary-color) !important;
        border-radius: 12px 12px 0 0 !important;
        padding: 8px 0 !important;
    }
    
    .flatpickr-month {
        color: white !important;
        font-weight: 600 !important;
    }
    
    .flatpickr-current-month {
        color: white !important;
        font-size: 1.1rem !important;
    }
    
    .flatpickr-monthDropdown-months {
        background: transparent !important;
        color: white !important;
        border: none !important;
        font-weight: 600 !important;
    }
    
    .flatpickr-monthDropdown-months option {
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
    }
    
    .flatpickr-weekdays {
        background: var(--bg-secondary) !important;
        padding: 8px 0 !important;
    }
    
    .flatpickr-weekday {
        color: var(--text-secondary) !important;
        font-weight: 600 !important;
        font-size: 0.9rem !important;
    }
    
    .flatpickr-days {
        background: var(--card-bg) !important;
        border-radius: 0 0 12px 12px !important;
    }
    
    .dayContainer {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
    }
    
    .flatpickr-day {
        color: var(--text-primary) !important;
        border: 1px solid transparent !important;
        border-radius: 8px !important;
        margin: 2px !important;
        width: calc(14.285% - 4px) !important;
        height: 40px !important;
        line-height: 40px !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
    }
    
    .flatpickr-day:hover {
        background: var(--primary-color) !important;
        color: white !important;
        border-color: var(--primary-color) !important;
    }
    
    .flatpickr-day.today {
        border-color: var(--primary-color) !important;
        color: var(--primary-color) !important;
        font-weight: bold !important;
    }
    
    .flatpickr-day.selected {
        background: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        color: white !important;
        font-weight: bold !important;
    }
    
    .flatpickr-day.disabled {
        color: var(--text-secondary) !important;
        background: transparent !important;
        cursor: not-allowed !important;
        opacity: 0.5 !important;
    }
    
    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
        color: var(--text-secondary) !important;
        opacity: 0.5 !important;
    }
    
    .flatpickr-day.prevMonthDay:hover,
    .flatpickr-day.nextMonthDay:hover {
        background: var(--primary-color) !important;
        color: white !important;
        opacity: 1 !important;
    }
    
    .flatpickr-day.available {
        background: var(--success-color) !important;
        color: white !important;
        border-color: var(--success-color) !important;
    }
    
    .flatpickr-day.available:hover {
        background: var(--success-color) !important;
        color: white !important;
        opacity: 0.8 !important;
    }

    /* Add these new styles */
    .availability-container-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 1.5rem;
    }

    .calendar-pane {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1rem;
        min-height: 400px;
        display: flex;
        flex-direction: column;
    }
    
    .calendar-pane h3 {
        margin: 0 0 1rem 0;
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    #datepicker {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .time-pane {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1rem;
        min-height: 400px;
    }

    .time-pane-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .time-pane-header i {
        color: var(--primary-color);
    }

    .time-pane-subheader {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    /* Responsive adjustments for the new layout */
    @media (max-width: 992px) {
        .availability-container-grid {
            grid-template-columns: 1fr;
        }
    }

    .booking-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .booking-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 1rem;
    }
    
    .step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .step.active {
        background: var(--primary-color);
        color: white;
    }
    
    .step.completed {
        background: var(--success-color);
        color: white;
    }
    
    .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .form-card {
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 16px;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-row.single {
        grid-template-columns: 1fr;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .form-group label {
        color: var(--text-primary);
        font-size: 0.95rem;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        background: var(--input-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 12px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Fix for select dropdown options */
    .form-group select option {
        background: var(--card-bg);
        color: var(--text-primary);
        padding: 8px 12px;
    }
    
    .form-group select option:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .doctors-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .doctor-card {
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .doctor-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    .doctor-card.selected {
        border-color: var(--primary-color);
        background: rgba(59, 130, 246, 0.05);
    }
    
    .doctor-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .doctor-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .doctor-info h3 {
        margin: 0;
        color: var(--text-primary);
        font-size: 1.1rem;
    }
    
    .doctor-info p {
        margin: 0.25rem 0 0 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .doctor-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
    }
    
    .detail-label {
        color: var(--text-secondary);
    }
    
    .detail-value {
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .availability-calendar {
        margin-top: 1rem;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .calendar-nav {
        display: flex;
        gap: 0.5rem;
    }
    
    .calendar-nav button {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .calendar-nav button:hover {
        background: var(--primary-dark);
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }
    
    .calendar-day {
        aspect-ratio: 1;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    
    .calendar-day:hover {
        border-color: var(--primary-color);
    }
    
    .calendar-day.available {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }
    
    .calendar-day.unavailable {
        background: var(--danger-color);
        color: white;
        border-color: var(--danger-color);
        cursor: not-allowed;
    }
    
    .calendar-day.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .time-slots {
        margin-top: 1rem;
    }
    
    .time-slots-container {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .time-slots-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .time-slots-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .time-slots-title i {
        color: var(--primary-color);
    }
    
    .time-slots-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    
    .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
        min-height: 200px;
    }
    
    .time-slot {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 1rem;
        position: relative;
        overflow: hidden;
    }
    
    .time-slot::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
    }
    
    .time-slot:hover {
        border-color: var(--primary-color);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    }
    
    .time-slot:hover::before {
        opacity: 1;
    }
    
    .time-slot:hover .time-slot-content {
        color: white;
    }
    
    .time-slot.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        transform: translateY(-2px);
    }
    
    .time-slot.selected::before {
        opacity: 0;
    }
    
    .time-slot-content {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }
    
    .time-slot-time {
        font-size: 1.1rem;
        font-weight: 700;
    }
    
    .time-slot-duration {
        font-size: 0.8rem;
        opacity: 0.8;
        font-weight: 400;
    }
    
    .time-slot-icon {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .no-slots-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 2px dashed var(--border-color);
    }
    
    .no-slots-message i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        opacity: 0.5;
    }
    
    .time-slots-info {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border-left: 4px solid var(--primary-color);
    }
    
    .time-slots-info h4 {
        margin: 0 0 0.5rem 0;
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    
    .selected-date-display {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .selected-date-display::before {
        content: 'ðŸ“…';
        font-size: 1rem;
    }
    
    .time-slots-info p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
        line-height: 1.4;
    }
    
    .time-slot.unavailable {
        background: var(--danger-color);
        color: white;
        border-color: var(--danger-color);
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: flex-end;
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: 10px;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
        cursor: pointer;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        border-color: var(--border-color);
        color: var(--text-secondary);
    }
    
    .btn-secondary:hover {
        background: var(--bg-secondary);
    }
    
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: var(--text-secondary);
    }
    
    .loading::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }
    
    .error-message {
        background: var(--danger-color);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .booking-container {
            padding: 1rem;
        }
        
        .booking-steps {
            flex-direction: column;
            align-items: center;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .doctors-grid {
            grid-template-columns: 1fr;
        }
        
        .calendar-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }
        
        .calendar-day {
            font-size: 0.8rem;
        }
        
        .time-slots-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }
        
        .time-slot {
            padding: 1rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .time-slot-time {
            font-size: 1rem;
        }
        
        .time-slots-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .selected-date-display {
            align-self: stretch;
            justify-content: center;
        }
        
        .actions {
            flex-direction: column;
        }
        
        /* Mobile-specific Flatpickr adjustments */
        .flatpickr-calendar {
            font-size: 14px !important;
        }
        
        .flatpickr-day {
            height: 35px !important;
            line-height: 35px !important;
            font-size: 14px !important;
        }
        
        .flatpickr-weekday {
            font-size: 12px !important;
        }
        
        .flatpickr-current-month {
            font-size: 16px !important;
        }
    }
</style>

<div class="booking-container">
    <header>
        <div class="header-title">
            <h1>Book an Appointment</h1>
            <p>Select a specialty, choose your doctor, and pick an available time slot.</p>
        </div>
        {% if selected_specialty %}
        <p style="margin-top:8px;">Selected: <strong>{{ selected_specialty.name }}</strong></p>
        {% endif %}
    </header>

    <div class="booking-steps">
        <div class="step active" id="step-1">
            <div class="step-number">1</div>
            <span>Select Specialty</span>
        </div>
        <div class="step" id="step-2">
            <div class="step-number">2</div>
            <span>Choose Doctor</span>
        </div>
        <div class="step" id="step-3">
            <div class="step-number">3</div>
            <span>Pick Time</span>
        </div>
        <div class="step" id="step-4">
            <div class="step-number">4</div>
            <span>Confirm</span>
        </div>
    </div>

    <form method="POST" action="{{ url_for('book_appointment') }}" id="booking-form">
        {% if prediction %}
            <input type="hidden" name="prediction_id" value="{{ prediction._id }}" />
        {% endif %}
        
        <!-- Step 1: Specialty Selection -->
        <div class="form-card" id="step-1-content">
            <h2>Select Medical Specialty</h2>
            <div class="form-row single">
                <div class="form-group">
                    <label for="specialty">Specialty</label>
                    <select id="specialty" name="specialty" required>
                        <option value="">Select specialty</option>
                        {% for key, spec in specialties.items() %}
                            <option value="{{ key }}" {% if selected_specialty_key == key %}selected{% endif %}>{{ spec.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="actions">
                <button type="button" class="btn btn-primary" onclick="nextStep()">Next: Choose Doctor</button>
            </div>
        </div>

        <!-- Step 2: Doctor Selection -->
        <div class="form-card" id="step-2-content" style="display: none;">
            <h2>Choose Your Doctor</h2>
            <div id="doctors-loading" class="loading">Loading available doctors...</div>
            <div id="doctors-container" style="display: none;">
                <div class="doctors-grid" id="doctors-grid"></div>
            </div>
            <div id="doctors-error" class="error-message" style="display: none;"></div>
            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                <button type="button" class="btn btn-primary" onclick="nextStep()" id="next-doctor-btn" disabled>Next: Pick Time</button>
            </div>
        </div>

        <!-- Step 3: Time Selection -->
        <div class="form-card" id="step-3-content" style="display: none;">
            <h2>Select Date and Time</h2>
            <div id="availability-loading" class="loading">Loading doctor availability...</div>
            
            <div id="availability-container" class="availability-container-grid" style="display: none;">
                <div class="calendar-pane">
                    <h3 id="selected-doctor-name-calendar"></h3>
                    <div id="datepicker"></div>
                </div>
                <div class="time-pane">
                    <h3 class="time-pane-header">
                        <i class="fas fa-clock"></i>
                        <span>Available Times</span>
                    </h3>
                    <p id="time-pane-date" class="time-pane-subheader">Please select a date from the calendar.</p>
                    <div id="time-slots-grid" class="time-slots-grid">
                        </div>
                </div>
            </div>
        
            <div id="availability-error" class="error-message" style="display: none;"></div>
            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                <button type="button" class="btn btn-primary" onclick="nextStep()" id="next-time-btn" disabled>Next: Confirm</button>
            </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="form-card" id="step-4-content" style="display: none;">
            <h2>Confirm Your Appointment</h2>
            <div id="appointment-summary">
                <div class="form-row">
                    <div class="form-group">
                        <label>Specialty</label>
                        <input type="text" id="summary-specialty" readonly>
                    </div>
                    <div class="form-group">
                        <label>Doctor</label>
                        <input type="text" id="summary-doctor" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" id="summary-date" readonly>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="text" id="summary-time" readonly>
                    </div>
                </div>
                <div class="form-row single">
                    <div class="form-group">
                        <label for="notes">Notes (optional)</label>
                        <textarea id="notes" name="notes" rows="4" placeholder="Brief symptoms or questions for the doctor."></textarea>
                    </div>
                </div>
            </div>
            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                <button type="submit" class="btn btn-primary">Confirm Booking</button>
            </div>
        </div>
    </form>

    {% if prediction %}
    <div class="form-card" style="margin-top:16px;">
        <h3 style="margin-top:0;">Attached Prediction Context</h3>
        <p><strong>Type:</strong> {{ prediction.disease_type|capitalize }} | <strong>Result:</strong> {{ prediction.prediction_result }} ({{ prediction.confidence_probability }}%)</p>
        <p style="margin:0; color: var(--text-light);">Made on {{ (prediction.timestamp).strftime('%B %d, %Y at %I:%M %p') }}</p>
        {% if prediction.patient_details %}
            <p style="margin-top:8px;"><strong>Patient:</strong> {{ prediction.patient_details.get('patientName', 'N/A') }}, {{ prediction.patient_details.get('patientAge', 'N/A') }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    let currentStep = 1;
    let selectedSpecialty = '';
    let selectedDoctor = null;
    let selectedDate = '';
    let selectedTime = '';
    let doctorAvailability = {};
    let calendarInstance = null; // To hold the flatpickr instance

    // Hidden form fields
    let specialtyInput = document.createElement('input');
    specialtyInput.type = 'hidden';
    specialtyInput.name = 'specialty';
    specialtyInput.id = 'specialty-hidden';

    let doctorInput = document.createElement('input');
    doctorInput.type = 'hidden';
    doctorInput.name = 'doctor_id';
    doctorInput.id = 'doctor-id-hidden';

    let dateInput = document.createElement('input');
    dateInput.type = 'hidden';
    dateInput.name = 'date';
    dateInput.id = 'date-hidden';

    let timeInput = document.createElement('input');
    timeInput.type = 'hidden';
    timeInput.name = 'time';
    timeInput.id = 'time-hidden';

    document.getElementById('booking-form').appendChild(specialtyInput);
    document.getElementById('booking-form').appendChild(doctorInput);
    document.getElementById('booking-form').appendChild(dateInput);
    document.getElementById('booking-form').appendChild(timeInput);

    function nextStep() {
        if (currentStep === 1) {
            const specialty = document.getElementById('specialty').value;
            if (!specialty) {
                alert('Please select a specialty');
                return;
            }
            selectedSpecialty = specialty;
            specialtyInput.value = specialty;
            loadDoctors(specialty);
        } else if (currentStep === 2) {
            if (!selectedDoctor) {
                alert('Please select a doctor');
                return;
            }
            loadDoctorAvailability();
        } else if (currentStep === 3) {
            if (!selectedDate || !selectedTime) {
                alert('Please select a date and time');
                return;
            }
            updateSummary();
        }
        
        if (currentStep < 4) {
            currentStep++;
            updateStepDisplay();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepDisplay();
        }
    }

    function updateStepDisplay() {
        // Update step indicators
        for (let i = 1; i <= 4; i++) {
            const step = document.getElementById(`step-${i}`);
            const content = document.getElementById(`step-${i}-content`);
            
            if (i < currentStep) {
                step.className = 'step completed';
                content.style.display = 'none';
            } else if (i === currentStep) {
                step.className = 'step active';
                content.style.display = 'block';
            } else {
                step.className = 'step';
                content.style.display = 'none';
            }
        }
    }

    async function loadDoctors(specialty) {
        const loadingDiv = document.getElementById('doctors-loading');
        const containerDiv = document.getElementById('doctors-container');
        const errorDiv = document.getElementById('doctors-error');
        const gridDiv = document.getElementById('doctors-grid');
        
        loadingDiv.style.display = 'block';
        containerDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        gridDiv.innerHTML = '';
        
        try {
            const response = await fetch(`/api/specialty/${specialty}/doctors`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            if (data.success) {
                if (data.doctors.length === 0) {
                    errorDiv.textContent = 'No doctors available for this specialty at the moment.';
                    errorDiv.style.display = 'block';
                } else {
                    displayDoctors(data.doctors);
                    containerDiv.style.display = 'block';
                }
            } else {
                errorDiv.textContent = data.error || 'Failed to load doctors';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            console.error("Doctor fetch error:", error);
            errorDiv.textContent = 'Failed to load doctors. Please try again.';
            errorDiv.style.display = 'block';
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    function displayDoctors(doctors) {
        const gridDiv = document.getElementById('doctors-grid');
        gridDiv.innerHTML = '';
        
        doctors.forEach(doctor => {
            const card = document.createElement('div');
            card.className = 'doctor-card';
            card.onclick = (event) => selectDoctor(event, doctor);
            
            const initials = doctor.full_name.split(' ').map(n => n[0]).join('');
            
            card.innerHTML = `
                <div class="doctor-header">
                    <div class="doctor-avatar">${initials}</div>
                    <div class="doctor-info">
                        <h3>${doctor.full_name}</h3>
                        <p>${doctor.qualification}</p>
                    </div>
                </div>
                <div class="doctor-details">
                    <div class="detail-item">
                        <span class="detail-label">Experience:</span>
                        <span class="detail-value">${doctor.experience_years} years</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">${doctor.status}</span>
                    </div>
                </div>
            `;
            
            gridDiv.appendChild(card);
        });
    }

    function selectDoctor(event, doctor) {
        selectedDoctor = doctor;
        
        document.querySelectorAll('.doctor-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        document.getElementById('next-doctor-btn').disabled = false;
        doctorInput.value = doctor._id;
    }

    // --- NEW & IMPROVED JAVASCRIPT FOR STEP 3 ---

    async function loadDoctorAvailability() {
        const loadingDiv = document.getElementById('availability-loading');
        const containerDiv = document.getElementById('availability-container');
        const errorDiv = document.getElementById('availability-error');
        
        loadingDiv.style.display = 'block';
        containerDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        
        document.getElementById('selected-doctor-name-calendar').textContent = `Availability for ${selectedDoctor.full_name}`;
        
        try {
            // Fetch availability for the next 60 days for a better UX
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(startDate.getDate() + 60);

            const response = await fetch(`/api/doctor/${selectedDoctor._id}/availability?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            console.log('Availability data:', data); // Debug log
            
            if (data.success) {
                doctorAvailability = data.availability;
                console.log('Doctor availability:', doctorAvailability); // Debug log
                initializeCalendar();
                containerDiv.style.display = 'grid'; // Use 'grid' for the new two-column layout
            } else {
                errorDiv.textContent = data.error || 'Failed to load availability';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            console.error("Availability fetch error:", error);
            errorDiv.textContent = 'Failed to load availability. Please try again.';
            errorDiv.style.display = 'block';
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    function initializeCalendar() {
        if (calendarInstance) {
            calendarInstance.destroy();
        }

        // Get available dates and ensure they're properly formatted
        const availableDates = doctorAvailability
            .filter(d => d.is_available && d.available_slots && d.available_slots.length > 0)
            .map(d => d.date);

        console.log('Available dates:', availableDates); // Debug log

        // If no available dates, allow all dates for testing
        const enableDates = availableDates.length > 0 ? availableDates : undefined;

        calendarInstance = flatpickr("#datepicker", {
            inline: true,
            dateFormat: "Y-m-d",
            minDate: "today",
            enable: enableDates,
            disableMobile: true,
            showMonths: 1,
            static: true,
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    selectDate(dateStr);
                }
            },
            onDayCreate: function(dObj, dStr, fp, dayElem) {
                // Add custom classes for better styling
                const dateStr = dayElem.dateObj.toISOString().split('T')[0];
                const availability = doctorAvailability.find(a => a.date === dateStr);
                
                if (availability && availability.is_available && availability.available_slots && availability.available_slots.length > 0) {
                    dayElem.classList.add('available');
                }
            }
        });

        // If no available dates, show a message
        if (availableDates.length === 0) {
            console.log('No available dates found - showing fallback message');
            document.getElementById('datepicker').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; display: block;"></i>
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">No Available Dates</h4>
                    <p style="margin: 0;">This doctor has no available appointments in the next 60 days.</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Please check back later or contact the hospital.</p>
                </div>
            `;
        }
    }

    function selectDate(date) {
        selectedDate = date;
        dateInput.value = date;

        selectedTime = '';
        timeInput.value = '';
        document.getElementById('next-time-btn').disabled = true;

        document.getElementById('time-pane-date').textContent = `On ${formatDateForDisplay(date)}`;
        
        const availabilityForDate = doctorAvailability.find(a => a.date === date);
        displayTimeSlots(availabilityForDate ? availabilityForDate.available_slots : []);
    }

    function displayTimeSlots(slots) {
        const gridDiv = document.getElementById('time-slots-grid');
        gridDiv.innerHTML = '';
        
        if (!slots || slots.length === 0) {
            gridDiv.innerHTML = `
                <div class="no-slots-message" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                    <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; display: block;"></i>
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">No Available Slots</h4>
                    <p style="margin: 0; color: var(--text-secondary);">No time slots are available for this date.<br>Please select another date.</p>
                </div>
            `;
            return;
        }
        
        slots.forEach(slot => {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'time-slot';
            slotDiv.onclick = (event) => selectTime(event, slot.start);
            
            slotDiv.innerHTML = `
                <div class="time-slot-content">
                    <div class="time-slot-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="time-slot-time">${formatTime12Hour(slot.start)}</div>
                    <div class="time-slot-duration">30 min session</div>
                </div>
            `;
            gridDiv.appendChild(slotDiv);
        });
    }

    function selectTime(event, time) {
        selectedTime = time;
        timeInput.value = time;
        
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        document.getElementById('next-time-btn').disabled = false;
    }

    function formatTime12Hour(time24) {
        if (!time24) return '';
        const [hours, minutes] = time24.split(':');
        const date = new Date(0, 0, 0, hours, minutes);
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    function updateSummary() {
        const specialtySelect = document.getElementById('specialty');
        const specialtyOption = specialtySelect.options[specialtySelect.selectedIndex];
        
        document.getElementById('summary-specialty').value = specialtyOption.text;
        document.getElementById('summary-doctor').value = selectedDoctor.full_name;
        document.getElementById('summary-date').value = formatDateForDisplay(selectedDate);
        // Use the 12-hour format for the summary display for better readability
        document.getElementById('summary-time').value = formatTime12Hour(selectedTime);
    }

    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function formatDateForDisplay(dateStr) {
        // Add time component to avoid timezone issues where new Date() might go to the previous day
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateStepDisplay();
        
        const specialtySelect = document.getElementById('specialty');
        if (specialtySelect.value) {
            selectedSpecialty = specialtySelect.value;
            specialtyInput.value = specialtySelect.value;
        }
    });
</script>
{% endblock %}


