{% extends "layout.html" %}

{% block title %}Image Prediction - Healthify{% endblock %}

{% block content %}
<style>
    .stepper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 800px;
        margin: 0 auto 30px auto;
        counter-reset: step;
    }

    .stepper .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        color: var(--text-light);
        flex: 1;
        text-align: center;
    }

    .stepper .step:before {
        counter-increment: step;
        content: counter(step);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .stepper .step:after {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background-color: var(--border-color);
        z-index: -1;
    }

    .stepper .step:last-child:after {
        content: none;
    }

    .stepper .step.active:before {
        background-color: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
    }

    .stepper .step.complete:before {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: #fff;
    }

    .prediction-view {
        display: none;
    }

    .prediction-view.active {
        display: block;
    }

    .analysis-selection, .patient-details-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .patient-details-form {
        max-width: 700px;
        margin: 0 auto;
        background: var(--card-bg);
        padding: 40px;
        border-radius: 15px;
        box-shadow: var(--shadow);
    }

    /* Utility to make a grid item span the full row */
    .patient-details-form .full-row {
        grid-column: 1 / -1;
    }

    .form-group {
        /* margin-bottom: 20px; */
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
    }

    .form-group input, .form-group select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--background-color);
        color: var(--text-color);
        font-size: 1rem;
    }

    /* Hide spinner arrows in number inputs */
    .patient-details-form input[type=number]::-webkit-outer-spin-button,
    .patient-details-form input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .patient-details-form input[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }

    .analysis-card {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        box-shadow: var(--shadow);
        color: var(--text-color);
    }

    .analysis-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5);
    }

    .analysis-card i {
        font-size: 3.5rem;
        margin-bottom: 20px;
        color: var(--primary-color);
    }

    .analysis-card h3 {
        font-size: 1.3rem;
        margin-bottom: 10px;
        color: var(--text-color);
    }

    .upload-area {
        background: var(--card-bg);
        padding: 40px;
        border-radius: 15px;
        box-shadow: var(--shadow);
        text-align: center;
        color: var(--text-light);
    }

    .drop-zone {
        border: 2px dashed var(--border-color);
        border-radius: 10px;
        padding: 50px;
        transition: background-color 0.3s, border-color 0.3s;
    }

    .drop-zone.dragover {
        border-color: var(--primary-color);
        background-color: rgba(96, 165, 250, 0.1);
    }

    .drop-zone i {
        font-size: 3rem;
        color: var(--text-light);
        margin-bottom: 20px;
    }

    .drop-zone p {
        font-weight: 500;
        color: var(--text-color);
    }

    .upload-btn {
        background-color: var(--primary-color);
        color: #fff;
        padding: 12px 25px;
        border-radius: 50px;
        cursor: pointer;
        display: inline-block;
        margin-top: 20px;
    }

    .preview-area,
    .result-area {
        background: var(--card-bg);
        padding: 40px;
        border-radius: 15px;
        box-shadow: var(--shadow);
        text-align: center;
        color: var(--text-color);
    }

    #imagePreview {
        max-width: 100%;
        max-height: 400px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    .btn-group {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        border: 2px solid var(--primary-color);
        transition: all 0.3s ease;
        text-decoration: none; /* For <a> tags styled as buttons */
        display: inline-block; /* For <a> tags */
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: #fff;
    }
    .btn-primary:hover {
        background-color: #3b82f6; 
    }

    .btn-secondary {
        background-color: transparent;
        color: var(--primary-color);
    }
    .btn-secondary:hover {
        background-color: rgba(96, 165, 250, 0.1);
    }

    .loading-spinner {
        font-size: 4rem;
        color: var(--primary-color);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .report-container {
        text-align: left;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    .report-container.positive {
        background-color: rgba(231, 76, 60, 0.1);
        border: 1px solid #e74c3c;
    }
    .report-container.negative {
        background-color: rgba(39, 174, 96, 0.1);
        border: 1px solid #27ae60;
    }
    .report-header {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    .report-header h2 {
        font-size: 1.8rem;
        margin: 0;
    }
    .report-header h2.positive { color: #e74c3c; }
    .report-header h2.negative { color: #27ae60; }

    .report-section {
        margin-bottom: 25px;
    }
    .report-section h3 {
        font-size: 1.2rem;
        color: var(--primary-color);
        margin-bottom: 10px;
    }
    .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .details-grid p {
        margin: 0;
        padding: 5px 0;
    }
    .details-grid strong {
        color: var(--text-color);
    }
</style>

<header>
    <div class="header-title">
        <h1>Image Analysis</h1>
        <p>Upload a medical image for AI-powered analysis.</p>
    </div>
</header>

<div class="stepper">
    <div id="step1" class="step active">Select Type</div>
    <div id="step2" class="step">Patient Details</div>
    <div id="step3" class="step">Upload Image</div>
    <div id="step4" class="step">Analyze</div>
    <div id="step5" class="step">Result</div>
</div>

<div class="prediction-container">
    <!-- Step 1: Select Analysis Type -->
    <div id="view1" class="prediction-view active">
        <div class="analysis-selection">
            <div class="analysis-card" data-type="retinopathy">
                <i class="fas fa-eye"></i>
                <h3>Diabetic Retinopathy Analysis</h3>
                <p>Upload a clear retinal fundus image (JPG or PNG).</p>
            </div>
            <div class="analysis-card" data-type="xray">
                <i class="fas fa-x-ray"></i>
                <h3>Pneumonia X-Ray Analysis</h3>
                <p>Upload a chest X-ray image (DICOM, PNG, or JPG).</p>
            </div>
        </div>
    </div>

    <!-- Step 2: Patient Details Form -->
    <div id="view2" class="prediction-view">
        <form id="patientForm" class="patient-details-form">
            <div class="form-group">
                <label for="patientName">Patient Full Name</label>
                <input type="text" id="patientName" name="patientName" required>
            </div>
            <div class="form-group">
                <label for="patientContact">Contact Number</label>
                <input type="tel" id="patientContact" name="patientContact">
            </div>
            <div class="form-group full-row">
                <label for="patientEmail">Email Address</label>
                <input type="email" id="patientEmail" name="patientEmail">
            </div>
            <div class="form-group">
                <label for="patientAge">Age</label>
                <input type="number" id="patientAge" name="patientAge" required min="0">
            </div>
            <div class="form-group">
                <label for="patientGender">Gender</label>
                <select id="patientGender" name="patientGender" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="btn-group full-row">
                <button type="button" id="backToTypeBtn" class="btn btn-secondary">Back</button>
                <button type="submit" id="proceedToUploadBtn" class="btn btn-primary">Proceed to Upload</button>
            </div>
        </form>
    </div>

    <!-- Step 3: Upload Image -->
    <div id="view3" class="prediction-view">
        <div class="upload-area">
            <div id="dropZone" class="drop-zone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag & Drop your image here, or</p>
                <label for="fileInput" class="upload-btn">Browse Files</label>
                <input type="file" id="fileInput" accept="image/*" hidden>
            </div>
             <div class="btn-group">
                <button type="button" id="backToPatientBtn" class="btn btn-secondary">Back</button>
            </div>
        </div>
    </div>

    <!-- Step 4: Preview & Confirmation -->
    <div id="view4" class="prediction-view">
        <div class="preview-area">
            <img id="imagePreview" src="#" alt="Image Preview">
            <div class="btn-group">
                <button id="changeBtn" class="btn btn-secondary">Change Image</button>
                <button id="analyzeBtn" class="btn btn-primary">Analyze</button>
            </div>
        </div>
    </div>

    <!-- Step 5: Loading & Result -->
    <div id="view5" class="prediction-view">
        <div class="result-area">
            <!-- Loading Spinner -->
            <div id="loadingView">
                <i class="fas fa-spinner loading-spinner"></i>
                <p style="margin-top: 20px;">Analyzing your image...</p>
            </div>
            <!-- Result Card -->
            <div id="resultView" style="display: none;">
                <div id="reportContainer" class="report-container">
                    <!-- Report will be dynamically inserted here -->
                </div>
                <div class="btn-group" style="margin-top: 30px;">
                    <a id="downloadBtn" class="btn btn-secondary" style="display: none;">Download Report</a>
                    <a href="{{ url_for('appointments') }}" id="bookAnAppointment" class="btn btn-primary">Book an Appointment</a>
                    <button id="startOverBtn" class="btn btn-primary">Start New Analysis</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const views = document.querySelectorAll('.prediction-view');
        const steps = document.querySelectorAll('.stepper .step');

        const analysisCards = document.querySelectorAll('.analysis-card');
        const patientForm = document.getElementById('patientForm');
        const backToTypeBtn = document.getElementById('backToTypeBtn');
        const backToPatientBtn = document.getElementById('backToPatientBtn');
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const changeBtn = document.getElementById('changeBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        const loadingView = document.getElementById('loadingView');
        const resultView = document.getElementById('resultView');
        const reportContainer = document.getElementById('reportContainer');

        let uploadedFile = null;
        let analysisType = '';
        let patientDetails = {};

        const goToView = (viewIndex) => {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(`view${viewIndex}`).classList.add('active');

            steps.forEach((s, i) => {
                s.classList.remove('active', 'complete');
                if (i < viewIndex - 1) s.classList.add('complete');
                if (i === viewIndex - 1) s.classList.add('active');
            });
        };

        const resetProcess = () => {
            uploadedFile = null;
            analysisType = '';
            patientDetails = {};
            fileInput.value = '';
            patientForm.reset();
            downloadBtn.style.display = 'none'; // Hide download button on reset
            goToView(1);
        };

        // Step 1 -> 2
        analysisCards.forEach(card => {
            card.addEventListener('click', () => {
                analysisType = card.dataset.type;
                goToView(2);
            });
        });
        
        backToTypeBtn.addEventListener('click', () => goToView(1));
        backToPatientBtn.addEventListener('click', () => goToView(2));

        // Step 2 -> 3
        patientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(patientForm);
            patientDetails = Object.fromEntries(formData.entries());
            goToView(3);
        });


        // Step 3 -> 4
        const handleFile = (file) => {
            if (file && file.type.startsWith('image/')) {
                uploadedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    goToView(4);
                };
                reader.readAsDataURL(file);
            }
        };

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));
        changeBtn.addEventListener('click', () => goToView(3));

        // Step 4 -> 5
        analyzeBtn.addEventListener('click', async () => {
            goToView(5);
            loadingView.style.display = 'block';
            resultView.style.display = 'none';
            downloadBtn.style.display = 'none';

            const formData = new FormData();
            formData.append('image', uploadedFile);
            formData.append('type', analysisType);
            for (const key in patientDetails) {
                formData.append(key, patientDetails[key]);
            }

            try {
                const response = await fetch("{{ url_for('image_prediction') }}", {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.statusText}`);
                }

                const data = await response.json();
                
                const isPositive = data.status.toLowerCase() === "positive";
                const statusClass = isPositive ? 'positive' : 'negative';

                reportContainer.className = `report-container ${statusClass}`;
                reportContainer.innerHTML = `
                    <div class="report-header">
                        <h2 class="${statusClass}">${data.title}</h2>
                        <p><strong>Analysis Confidence:</strong> ${data.confidence_level} (${data.raw_confidence}%)</p>
                    </div>
                    <div class="report-section">
                        <h3>Patient Information</h3>
                        <div class="details-grid">
                            <p><strong>Name:</strong> ${data.patient_details.patientName}</p>
                            <p><strong>Age:</strong> ${data.patient_details.patientAge}</p>
                            <p><strong>Gender:</strong> ${data.patient_details.patientGender}</p>
                            <p><strong>Contact:</strong> ${data.patient_details.patientContact || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="report-section">
                        <h3>AI Analysis Details</h3>
                        <p><strong>What this means:</strong> ${data.explanation}</p>
                        <p style="margin-top: 15px;"><strong>Next Steps:</strong> ${data.next_steps}</p>
                    </div>
                     <div class="disclaimer" style="text-align:center; margin-top: 20px;">
                        <strong>Disclaimer:</strong> This is an AI-powered tool and not a substitute for a professional
                        medical diagnosis. Please consult a doctor for any health concerns.
                    </div>
                `;

                const buttonGroup = document.querySelector('#resultView .btn-group');
                
                // Clean up old doctor buttons before adding a new one
                const oldDoctorBtn = buttonGroup.querySelector('.btn-doctor-suggestion');
                if (oldDoctorBtn) {
                    oldDoctorBtn.remove();
                }

                // Add doctor suggestion button if a URL is provided
                if (data.doctor_url) {
                    const doctorLink = document.createElement('a');
                    doctorLink.href = data.doctor_url;
                    doctorLink.textContent = 'Find a Specialist';
                    doctorLink.className = 'btn btn-primary btn-doctor-suggestion';
                    buttonGroup.insertBefore(doctorLink, startOverBtn);
                }

                // Set up and show the download button
                if (data.prediction_id) {
                    downloadBtn.href = `/download_report/${data.prediction_id}`;
                    downloadBtn.style.display = 'inline-block';
                }


            } catch (error) {
                console.error("Analysis Error:", error);
                reportContainer.className = 'report-container positive';
                reportContainer.innerHTML = `
                    <div class="report-header">
                        <h2 class="positive">Analysis Failed</h2>
                    </div>
                    <div class="report-section">
                         <p>${error.message}</p>
                         <p>Please check the image file or try again later.</p>
                    </div>
                `;
            } finally {
                loadingView.style.display = 'none';
                resultView.style.display = 'block';
            }
        });

        startOverBtn.addEventListener('click', resetProcess);
    });
</script>
{% endblock %}
